<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Sync Tool</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/app.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>ğŸ”„</span>
                Media Sync Tool
            </h1>
            <p>Sync media from your configured sources</p>
        </div>
        
        <div class="tab-navigation">
            <button class="tab-button active" onclick="showTab('sync')">
                ğŸ”„ Sync Operations
            </button>
            <button class="tab-button" onclick="showTab('vastai-setup')">
                âš™ï¸ VastAI Setup
            </button>
        </div>
        
        <div id="sync-tab" class="tab-content active">
            <div class="options-panel">
                <label class="checkbox-container">
                    <input type="checkbox" id="cleanupCheckbox" checked>
                    <span>ğŸ§¹ Enable cleanup (delete remote folders older than 2 days)</span>
                </label>
            </div>
            
            <div class="sync-grid">
                <button class="sync-button" onclick="sync('forge')">
                    <span>ğŸ”¥</span>
                    Sync Forge
                </button>
                <button class="sync-button" onclick="sync('comfy')">
                    <span>ğŸ–¼ï¸</span>
                    Sync Comfy
                </button>
                <button class="sync-button" onclick="sync('vastai')">
                    <span>â˜ï¸</span>
                    Sync VastAI
                </button>
                <button class="sync-button secondary" onclick="testSSH()">
                    <span>ğŸ”§</span>
                    Test SSH
                </button>
                <button class="sync-button secondary" onclick="runSSHDiagnostics()">
                    <span>ğŸ©º</span>
                    SSH Diagnostics
                </button>
            </div>
        </div>
        
        <div id="vastai-setup-tab" class="tab-content">
            <h3>VastAI SSH Connection Setup</h3>
            <p>Configure your VastAI SSH connection and manage UI_HOME settings.</p>
            
            <!-- VastAI Instances Section -->
            <div class="vastai-instances-section">
                <h4>ğŸ–¥ï¸ Active VastAI Instances</h4>
                <div class="instances-buttons">
                    <button class="setup-button secondary" onclick="loadVastaiInstances()">
                        ğŸ”„ Load Instances
                    </button>
                    <button class="setup-button" onclick="openSearchOffersModal()">
                        Search Offers
                    </button>
                </div>
                <div id="vastai-instances-list" class="instances-list">
                    <!-- Instances will be displayed here -->
                    <div class="no-instances-message">Click "Load Instances" to see your active VastAI instances</div>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: 1px solid var(--background-modifier-border);">
            
            <div class="setup-field">
                <label for="sshConnectionString">SSH Connection String:</label>
                <input type="text" id="sshConnectionString" 
                       placeholder="ssh -p 2838 root@104.189.178.116 -L 8080:localhost:8080"
                       title="Enter the SSH connection string from your VastAI instance">
            </div>
            
            <div class="setup-buttons">
                <button class="setup-button" onclick="syncFromConnectionString()">
                    ğŸ”„ Sync Instance
                </button>
                <button class="setup-button" onclick="setUIHome()">
                    ğŸ“ Set UI_HOME to /workspace/ComfyUI/
                </button>
                <button class="setup-button secondary" onclick="getUIHome()">
                    ğŸ“– Read UI_HOME
                </button>
                <button class="setup-button" onclick="setupCivitDL()">
                    ğŸ¨ Setup CivitDL
                </button>
                <button class="setup-button danger" onclick="terminateConnection()">
                    ğŸ”Œ Terminate Connection
                </button>
            </div>
            
            <div id="setup-result" class="setup-result">
                <!-- Results will be displayed here -->
            </div>
            
            <!-- VastAI Logs Section -->
            <div class="vastai-logs-section">
                <h4>ğŸ“‹ VastAI Logs</h4>
                <div class="logs-controls">
                    <label for="vastaiLogLines">Lines to retrieve:</label>
                    <input type="number" id="vastaiLogLines" value="50" min="1" max="1000" step="1">
                    <button class="setup-button secondary" onclick="refreshVastAILogs()">ğŸ”„ Refresh</button>
                </div>
                <div id="vastai-logs-list" class="logs-list">
                    <div class="no-logs-message">Click "Refresh" to load VastAI API logs</div>
                </div>
            </div>
        </div>
        
        <div id="result" class="result-panel" title="Click to view full report"></div>
        
        <div id="progress" class="progress-panel">
            <h3>Sync Progress</h3>
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill"></div>
            </div>
            <div id="progressText" class="progress-text">Initializing...</div>
            <div id="progressDetails" class="progress-text"></div>
        </div>
        
        <div id="logs" class="logs-panel">
            <h3>
                Recent Sync Logs
                <button class="refresh-logs-btn" onclick="refreshLogs()">ğŸ”„ Refresh</button>
            </h3>
            <div id="logsList" class="logs-list">
                <div class="no-logs-message">Click refresh to load recent logs</div>
            </div>
        </div>
    </div>
    
    <!-- Log detail overlay -->
    <div id="logOverlay" class="log-overlay">
        <div class="log-modal">
            <div class="log-modal-header">
                <h3 id="logModalTitle" class="log-modal-title">Log Details</h3>
                <button class="close-modal-btn" onclick="closeLogModal()">âœ•</button>
            </div>
            <div id="logModalContent" class="log-modal-content">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Search offers overlay -->
    <div id="searchOffersOverlay" class="log-overlay">
        <div class="search-offers-modal">
            <div class="log-modal-header">
                <h3 class="log-modal-title">ğŸ” Search VastAI Offers</h3>
                <button class="close-modal-btn" onclick="closeSearchOffersModal()">âœ•</button>
            </div>
            <div class="search-offers-content">
                <!-- Pill Bar -->
                <div class="pillbar" id="pillbar">
                    <button class="pill" id="pill-search" data-filter="search" 
                            aria-haspopup="false" aria-expanded="false">
                        Search
                    </button>
                    <button class="pill" id="pill-sort" data-filter="sort" 
                            aria-haspopup="listbox" aria-expanded="false">
                        Sort: Price/hr
                    </button>
                    <button class="pill" id="pill-vram" data-filter="vram" 
                            aria-haspopup="dialog" aria-expanded="false">
                        VRAM: Any
                    </button>
                    <button class="pill" id="pill-pcie" data-filter="pcie" 
                            aria-haspopup="dialog" aria-expanded="false">
                        PCIe: Any
                    </button>
                    <button class="pill" id="pill-net" data-filter="net" 
                            aria-haspopup="dialog" aria-expanded="false">
                        Net: Any
                    </button>
                    <button class="pill" id="pill-location" data-filter="location" 
                            aria-haspopup="listbox" aria-expanded="false">
                        Location: Any
                    </button>
                    <button class="pill" id="pill-gpuModel" data-filter="gpuModel" 
                            aria-haspopup="dialog" aria-expanded="false">
                        GPU Model: Any
                    </button>
                    <button class="pill" id="pill-priceCap" data-filter="priceCap" 
                            aria-haspopup="dialog" aria-expanded="false">
                        Price: Any
                    </button>
                </div>
                
                <!-- Mobile Inline Editor Panel -->
                <div class="pill-editor" id="pill-editor" role="region" style="display: none;">
                    <!-- Editor content will be injected here -->
                </div>
                <div id="searchResults" class="search-results">
                    <div class="no-results-message">Enter search criteria and click "Search Offers" to find available instances</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript files -->
    <script src="js/state.js"></script>
    <script src="js/api.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/logs.js"></script>
    <script src="js/vastai.js"></script>
    <script src="js/main.js"></script>
</body>
</html>