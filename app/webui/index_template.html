<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Sync Tool</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/app.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üîÑ</span>
                Media Sync Tool
            </h1>
            <p>Sync media from your configured sources</p>
        </div>
        
        <div class="tab-navigation">
            <button class="tab-button active" onclick="showTab('sync')">
                üîÑ Sync Operations
            </button>
            <button class="tab-button" onclick="showTab('vastai-setup')">
                ‚öôÔ∏è VastAI Setup
            </button>
        </div>
        
        <div id="sync-tab" class="tab-content active">
            <div class="options-panel">
                <label class="checkbox-container">
                    <input type="checkbox" id="cleanupCheckbox" checked>
                    <span>üßπ Enable cleanup (delete remote folders older than 2 days)</span>
                </label>
            </div>
            
            <div class="sync-grid">
                <button class="sync-button" onclick="sync('forge')">
                    <span>üî•</span>
                    Sync Forge
                </button>
                <button class="sync-button" onclick="sync('comfy')">
                    <span>üñºÔ∏è</span>
                    Sync Comfy
                </button>
                <button class="sync-button" onclick="sync('vastai')">
                    <span>‚òÅÔ∏è</span>
                    Sync VastAI
                </button>
                <button class="sync-button secondary" onclick="testSSH()">
                    <span>üîß</span>
                    Test SSH
                </button>
            </div>
        </div>
        
        <div id="vastai-setup-tab" class="tab-content">
            <h3>VastAI SSH Connection Setup</h3>
            <p>Configure your VastAI SSH connection and manage UI_HOME settings.</p>
            
            <!-- VastAI Instances Section -->
            <div class="vastai-instances-section">
                <h4>üñ•Ô∏è Active VastAI Instances</h4>
                <div class="instances-buttons">
                    <button class="setup-button secondary" onclick="loadVastaiInstances()">
                        üîÑ Load Instances
                    </button>
                    <button class="setup-button" onclick="openSearchOffersModal()">
                        Search Offers
                    </button>
                </div>
                <div id="vastai-instances-list" class="instances-list">
                    <!-- Instances will be displayed here -->
                    <div class="no-instances-message">Click "Load Instances" to see your active VastAI instances</div>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: 1px solid var(--background-modifier-border);">
            
            <div class="setup-field">
                <label for="sshConnectionString">SSH Connection String:</label>
                <input type="text" id="sshConnectionString" 
                       placeholder="ssh -p 2838 root@104.189.178.116 -L 8080:localhost:8080"
                       title="Enter the SSH connection string from your VastAI instance">
            </div>
            
            <div class="setup-buttons">
                <button class="setup-button" onclick="syncFromConnectionString()">
                    üîÑ Sync Instance
                </button>
                <button class="setup-button" onclick="setUIHome()">
                    üìÅ Set UI_HOME to /workspace/ComfyUI/
                </button>
                <button class="setup-button secondary" onclick="getUIHome()">
                    üìñ Read UI_HOME
                </button>
                <button class="setup-button" onclick="setupCivitDL()">
                    üé® Setup CivitDL
                </button>
                <button class="setup-button danger" onclick="terminateConnection()">
                    üîå Terminate Connection
                </button>
            </div>
            
            <div id="setup-result" class="setup-result">
                <!-- Results will be displayed here -->
            </div>
        </div>
        
        <div id="result" class="result-panel" title="Click to view full report"></div>
        
        <div id="progress" class="progress-panel">
            <h3>Sync Progress</h3>
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill"></div>
            </div>
            <div id="progressText" class="progress-text">Initializing...</div>
            <div id="progressDetails" class="progress-text"></div>
        </div>
        
        <div id="logs" class="logs-panel">
            <h3>
                Recent Sync Logs
                <button class="refresh-logs-btn" onclick="refreshLogs()">üîÑ Refresh</button>
            </h3>
            <div id="logsList" class="logs-list">
                <div class="no-logs-message">Click refresh to load recent logs</div>
            </div>
        </div>
    </div>
    
    <!-- Log detail overlay -->
    <div id="logOverlay" class="log-overlay">
        <div class="log-modal">
            <div class="log-modal-header">
                <h3 id="logModalTitle" class="log-modal-title">Log Details</h3>
                <button class="close-modal-btn" onclick="closeLogModal()">‚úï</button>
            </div>
            <div id="logModalContent" class="log-modal-content">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Search offers overlay -->
    <div id="searchOffersOverlay" class="log-overlay">
        <div class="search-offers-modal">
            <div class="log-modal-header">
                <h3 class="log-modal-title">üîç Search VastAI Offers</h3>
                <button class="close-modal-btn" onclick="closeSearchOffersModal()">‚úï</button>
            </div>
            <div class="search-offers-content">
                <!-- Pill Bar for Search Criteria -->
                <div class="pillbar-container">
                    <div class="pillbar" id="pillbar">
                        <button class="pill pill-search" id="searchPill" onclick="searchVastaiOffers()">
                            üîç Search
                        </button>
                        <button class="pill" id="sortPill" onclick="togglePillPopover('sort')" aria-haspopup="listbox">
                            Sort: Price/hr
                        </button>
                        <button class="pill" id="vramPill" onclick="togglePillPopover('vram')" aria-haspopup="dialog">
                            VRAM: Any
                        </button>
                        <button class="pill" id="pciePill" onclick="togglePillPopover('pcie')" aria-haspopup="dialog">
                            PCIe: Any
                        </button>
                        <button class="pill" id="netPill" onclick="togglePillPopover('net')" aria-haspopup="dialog">
                            Net: Any
                        </button>
                        <button class="pill" id="locationPill" onclick="togglePillPopover('location')" aria-haspopup="dialog">
                            Location: Any
                        </button>
                        <button class="pill" id="gpuModelPill" onclick="togglePillPopover('gpuModel')" aria-haspopup="dialog">
                            GPU: Any
                        </button>
                        <button class="pill" id="pricePill" onclick="togglePillPopover('price')" aria-haspopup="dialog">
                            Price: Any
                        </button>
                    </div>
                </div>
                
                <!-- Pill Popovers Container -->
                <div id="pill-popovers">
                    <!-- Sort Popover -->
                    <div id="sortPopover" class="pill-popover" role="listbox" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-title">Sort by</div>
                            <div class="radio-list">
                                <label class="radio-option">
                                    <input type="radio" name="sortOption" value="dph_total" checked>
                                    <span>Price/hr</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="sortOption" value="score">
                                    <span>Score</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="sortOption" value="gpu_ram">
                                    <span>GPU RAM</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="sortOption" value="reliability">
                                    <span>Reliability</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VRAM Popover -->
                    <div id="vramPopover" class="pill-popover" role="dialog" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-title">Minimum GPU RAM (GB)</div>
                            <div class="numeric-controls">
                                <input type="range" id="vramSlider" min="1" max="80" value="10" step="1" class="slider">
                                <input type="number" id="vramInput" min="1" max="80" value="10" class="numeric-input">
                            </div>
                            <div class="quick-chips">
                                <button class="chip" onclick="setVramValue(8)">8</button>
                                <button class="chip" onclick="setVramValue(16)">16</button>
                                <button class="chip" onclick="setVramValue(24)">24</button>
                                <button class="chip" onclick="setVramValue(32)">32</button>
                                <button class="chip" onclick="setVramValue(48)">48</button>
                                <button class="chip" onclick="setVramValue(80)">80</button>
                            </div>
                            <div class="popover-actions">
                                <button class="popover-btn secondary" onclick="clearVramFilter()">Clear</button>
                                <button class="popover-btn primary" onclick="applyVramFilter()">Apply</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PCIe Popover -->
                    <div id="pciePopover" class="pill-popover" role="dialog" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-title">Minimum PCIe Bandwidth (GB/s)</div>
                            <div class="numeric-controls">
                                <input type="range" id="pcieSlider" min="1" max="64" value="16" step="1" class="slider">
                                <input type="number" id="pcieInput" min="1" max="64" value="16" class="numeric-input">
                            </div>
                            <div class="quick-chips">
                                <button class="chip" onclick="setPcieValue(8)">8</button>
                                <button class="chip" onclick="setPcieValue(16)">16</button>
                                <button class="chip" onclick="setPcieValue(32)">32</button>
                                <button class="chip" onclick="setPcieValue(64)">64</button>
                            </div>
                            <div class="popover-actions">
                                <button class="popover-btn secondary" onclick="clearPcieFilter()">Clear</button>
                                <button class="popover-btn primary" onclick="applyPcieFilter()">Apply</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Net Popover -->
                    <div id="netPopover" class="pill-popover" role="dialog" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-title">Network Speed (Mbps)</div>
                            <div class="net-controls">
                                <div class="net-group">
                                    <label>Upload ‚â•</label>
                                    <input type="range" id="netUpSlider" min="0" max="1000" value="100" step="10" class="slider">
                                    <input type="number" id="netUpInput" min="0" max="1000" value="100" class="numeric-input">
                                </div>
                                <div class="net-group">
                                    <label>Download ‚â•</label>
                                    <input type="range" id="netDownSlider" min="0" max="1000" value="100" step="10" class="slider">
                                    <input type="number" id="netDownInput" min="0" max="1000" value="100" class="numeric-input">
                                </div>
                            </div>
                            <div class="popover-actions">
                                <button class="popover-btn secondary" onclick="clearNetFilter()">Clear</button>
                                <button class="popover-btn primary" onclick="applyNetFilter()">Apply</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location Popover -->
                    <div id="locationPopover" class="pill-popover" role="dialog" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-title">Location</div>
                            <div class="search-controls">
                                <input type="text" id="locationSearch" placeholder="Search countries..." class="search-input">
                            </div>
                            <div class="checkbox-list" id="locationList">
                                <label class="checkbox-option">
                                    <input type="checkbox" value="US"> United States
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" value="CA"> Canada
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" value="GB"> United Kingdom
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" value="DE"> Germany
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" value="FR"> France
                                </label>
                            </div>
                            <div class="popover-actions">
                                <button class="popover-btn tertiary" onclick="selectAllLocations()">All</button>
                                <button class="popover-btn tertiary" onclick="selectNoLocations()">None</button>
                                <button class="popover-btn secondary" onclick="clearLocationFilter()">Clear</button>
                                <button class="popover-btn primary" onclick="applyLocationFilter()">Apply</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GPU Model Popover -->
                    <div id="gpuModelPopover" class="pill-popover" role="dialog" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-title">GPU Model</div>
                            <div class="search-controls">
                                <input type="text" id="gpuModelInput" placeholder="Type GPU model..." class="search-input">
                            </div>
                            <div class="suggestion-list" id="gpuModelSuggestions" style="display: none;">
                                <!-- Suggestions will be populated dynamically -->
                            </div>
                            <div class="popover-actions">
                                <button class="popover-btn secondary" onclick="clearGpuModelFilter()">Clear</button>
                                <button class="popover-btn primary" onclick="applyGpuModelFilter()">Apply</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Popover -->
                    <div id="pricePopover" class="pill-popover" role="dialog" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-title">Maximum Price per Hour ($)</div>
                            <div class="numeric-controls">
                                <input type="range" id="priceSlider" min="0.01" max="5.00" value="1.00" step="0.01" class="slider">
                                <input type="number" id="priceInput" min="0.01" max="5.00" value="1.00" step="0.01" class="numeric-input">
                            </div>
                            <div class="quick-chips">
                                <button class="chip" onclick="setPriceValue(0.25)">$0.25</button>
                                <button class="chip" onclick="setPriceValue(0.50)">$0.50</button>
                                <button class="chip" onclick="setPriceValue(1.00)">$1.00</button>
                                <button class="chip" onclick="setPriceValue(2.00)">$2.00</button>
                            </div>
                            <div class="popover-actions">
                                <button class="popover-btn secondary" onclick="clearPriceFilter()">Clear</button>
                                <button class="popover-btn primary" onclick="applyPriceFilter()">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="searchResults" class="search-results">
                    <div class="no-results-message">Enter search criteria and click "Search" to find available instances</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript files -->
    <script src="js/state.js"></script>
    <script src="js/api.js"></script>
    <script src="js/pillbar.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/logs.js"></script>
    <script src="js/vastai.js"></script>
    <script src="js/main.js"></script>
</body>
</html>