@app.route('/vastai/instances/<int:instance_id>/open-button-token', methods=['POST', 'OPTIONS'])
def get_open_button_token(instance_id):
    """Get OPEN_BUTTON_TOKEN from a VastAI instance via SSH"""
    if request.method == 'OPTIONS':
        return ("", 204)
    
    try:
        data = request.get_json() if request.is_json else {}
        ssh_connection = data.get('ssh_connection')
        
        if not ssh_connection:
            return jsonify({
                'success': False,
                'message': 'SSH connection string is required'
            })
        
        try:
            ssh_host, ssh_port = _extract_host_port(ssh_connection)
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Invalid SSH connection string: {str(e)}'
            })
        
        # Check if host key is verified
        host_key_manager = SSHHostKeyManager()
        
        if not host_key_manager.is_host_key_verified(ssh_host, ssh_port):
            # Get the host key for verification
            try:
                result = subprocess.run(
                    ['ssh-keyscan', '-p', str(ssh_port), ssh_host],
                    capture_output=True,
                    text=True,
                    timeout=10
                )
                
                if result.returncode == 0 and result.stdout:
                    # Parse the key from ssh-keyscan output
                    for line in result.stdout.strip().split('\n'):
                        if line and not line.startswith('#'):
                            parts = line.split()
                            if len(parts) >= 3:
                                key_type = parts[1]
                                key = parts[2]
                                fingerprint = host_key_manager._get_key_fingerprint(key)
                                
                                return jsonify({
                                    'success': False,
                                    'require_verification': True,
                                    'host': ssh_host,
                                    'port': ssh_port,
                                    'key_type': key_type,
                                    'fingerprint': fingerprint,
                                    'key': key
                                })
                
                return jsonify({
                    'success': False,
                    'message': f'Could not retrieve host key from {ssh_host}:{ssh_port}'
                })
                
            except subprocess.TimeoutExpired:
                return jsonify({
                    'success': False,
                    'message': 'Timeout while retrieving host key'
                })
            except Exception as e:
                return jsonify({
                    'success': False,
                    'message': f'Error retrieving host key: {str(e)}'
                })
        
        # Host key is verified, proceed with SSH command
        try:
            result = subprocess.run(
                ['ssh', '-p', str(ssh_port), f'root@{ssh_host}', 'echo $OPEN_BUTTON_TOKEN'],
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode == 0:
                token = result.stdout.strip()
                if token:
                    return jsonify({
                        'success': True,
                        'token': token
                    })
                else:
                    return jsonify({
                        'success': False,
                        'message': 'OPEN_BUTTON_TOKEN is not set on the instance'
                    })
            else:
                error_msg = result.stderr.strip() if result.stderr else 'SSH command failed'
                return jsonify({
                    'success': False,
                    'message': f'SSH error: {error_msg}'
                })
                
        except subprocess.TimeoutExpired:
            return jsonify({
                'success': False,
                'message': 'SSH command timed out'
            })
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error executing SSH command: {str(e)}'
            })
            
    except Exception as e:
        logger.error(f"Error getting open button token for instance {instance_id}: {str(e)}")
        return jsonify({
            'success': False,
            'message': f'Error: {str(e)}'
        })


